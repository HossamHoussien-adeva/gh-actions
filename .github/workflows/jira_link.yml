name: jira-description-action
on:
  pull_request:
    types: [opened, edited]
    branches: ['master', 'main']

jobs:
  add-jira-description:
    permissions:
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Find Jira Issue ID
        id: jiraIssueId
        uses: atlassian/gajira-find-issue-key@v3
        with:
          from: branch

      - name: Fetch Jira Issue Details
        id: jiraGetIssue
        uses: fjogeleit/http-request-action@main
        with:
          url: 'https://adeva.atlassian.net/rest/api/3/issue/PLAT-${{ steps.jiraIssueId.outputs.issue }}?fields=summary'
          method: 'GET'
          customHeaders: '{"Authorization": "Basic ${{ secrets.JIRA_TOKEN }}"}'

      - uses: seripap/pr-update-action@v3.1.6
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          base-branch-regex: 'master|main'
          title-template: '[${{ fromJson(steps.jiraGetIssue.outputs.response).key }}] - ${{ fromJson(steps.jiraGetIssue.outputs.response).fields.summary }}'
          body-template: 'https://adeva.atlassian.net/browse/${{ fromJson(steps.jiraGetIssue.outputs.response).key }}'
          title-update-action: 'replace'
          body-update-action: 'prefix'

